<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - RacquetDesk Auto-Booker</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ¾ RacquetDesk Auto-Booker</h1>
      <div class="header-actions">
        <span id="rdStatus" class="status-badge <%= isLoggedIn ? 'online' : 'offline' %>">
          <%= isLoggedIn ? 'âœ“ Connected' : 'âœ— Disconnected' %>
        </span>
        <a href="/logout" class="btn btn-small">Logout</a>
      </div>
    </header>

    <!-- Booking Mode Selector -->
    <div class="card mode-card">
      <div class="mode-header">
        <span>ğŸ“Œ Default Booking Mode:</span>
      </div>
      <div class="mode-buttons">
        <button id="modeBook" class="btn mode-btn <%= bookingMode === 'book' ? 'active' : '' %>">
          ğŸ¯ Book + Waitlist
        </button>
        <button id="modeWaitlist" class="btn mode-btn <%= bookingMode === 'waitlist' ? 'active' : '' %>">
          ğŸ“‹ Waitlist Only
        </button>
      </div>
      <div class="mode-description">
        <small>
          <strong>ğŸ¯ Book + Waitlist:</strong> Try direct booking first, auto-fallback to waitlist if full<br>
          <strong>ğŸ“‹ Waitlist Only:</strong> Only add to waitlist (for slots that are already full)<br>
          <em>Note: You can also set mode per-slot when adding to tasks.</em>
        </small>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="schedule">ğŸ“… Schedule</button>
      <button class="tab" data-tab="tasks">ğŸ“‹ Tasks <span class="badge" id="tasksBadge"><%= tasks.length %></span></button>
      <button class="tab" data-tab="mybookings">ğŸ« My Bookings</button>
      <button class="tab" data-tab="polling">ğŸ”„ Polling</button>
      <button class="tab" data-tab="settings">âš™ï¸ Settings</button>
      <button class="tab" data-tab="logs">ğŸ“œ Logs</button>
    </div>

    <!-- Schedule Tab -->
    <div id="schedule-tab" class="tab-content active">
      <div class="card">
        <h2>ğŸ“… Fetch Schedule</h2>
        <div class="form-row">
          <input type="date" id="scheduleDate" value="<%= new Date(Date.now() + 86400000).toISOString().split('T')[0] %>">
          <button class="btn btn-primary" id="fetchSchedule">Fetch Schedule</button>
        </div>
      </div>

      <div class="card">
        <h2>Available Slots <span class="badge" id="slotCount">0</span></h2>
        <div class="filters">
          <label><input type="checkbox" id="filterAM" checked> AM</label>
          <label><input type="checkbox" id="filterPM" checked> PM</label>
          <div class="time-range-filter">
            <input type="time" id="filterTimeStart" value="07:00" title="Start time">
            <span>-</span>
            <input type="time" id="filterTimeEnd" value="22:00" title="End time">
          </div>
          <input type="text" id="filterExclude" placeholder="Exclude keywords (comma separated)" value="Closed,Pickleball">
        </div>
        <div id="scheduleList" class="slot-list">
          <div class="empty-state">Select a date and fetch schedule</div>
        </div>
        <div class="action-buttons" id="scheduleActions" style="display:none;">
          <button class="btn btn-success" id="bookSelectedNow">ğŸ¯ Book Selected Now</button>
          <button class="btn btn-primary" id="addToTasks">ğŸ“‹ Add to Tasks</button>
        </div>
      </div>
    </div>

    <!-- Tasks Tab -->
    <div id="tasks-tab" class="tab-content">
      <div class="card">
        <h2>ğŸ“‹ Scheduled Tasks</h2>
        <p class="info">Tasks will be processed during polling. Each task uses its own booking mode.</p>
        <div id="tasksList" class="task-list">
          <% if (tasks.length === 0) { %>
            <div class="empty-state">No tasks scheduled</div>
          <% } else { %>
            <% tasks.forEach(task => { %>
              <div class="task-item" data-id="<%= task.id %>">
                <div class="task-info">
                  <strong><%= task.scheduleDate %></strong>
                  <span>
                    <%= task.slot.resources %> - <%= new Date(task.slot.start).toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'}) %>
                    <span class="task-mode-badge <%= task.mode === 'book' ? 'book' : 'waitlist' %>">
                      <%= task.mode === 'book' ? 'ğŸ¯ Book' : 'ğŸ“‹ Waitlist' %>
                    </span>
                  </span>
                </div>
                <button class="btn btn-small btn-danger delete-task">âœ•</button>
              </div>
            <% }) %>
          <% } %>
        </div>
        <% if (tasks.length > 0) { %>
          <button class="btn btn-danger" id="clearAllTasks">Clear All Tasks</button>
        <% } %>
      </div>
    </div>

    <!-- My Bookings Tab (æ–°å¢) -->
    <div id="mybookings-tab" class="tab-content">
      <div class="card">
        <h2>ğŸ« My Bookings & Waitlists</h2>
        <div class="button-group" style="margin-bottom: 15px;">
          <button class="btn btn-primary" id="refreshMyBookings">ğŸ”„ Refresh</button>
          <button class="btn btn-danger" id="cancelSelectedBookings" disabled>ğŸ—‘ï¸ Cancel Selected</button>
        </div>
        
        <div id="myBookingsContent">
          <div class="empty-state">Click "Refresh" to load your bookings</div>
        </div>
      </div>
    </div>

    <!-- Polling Tab -->
    <div id="polling-tab" class="tab-content">
      <div class="card">
        <h2>ğŸ”„ Polling Status</h2>
        <div class="polling-status <%= pollingState.active ? 'active' : '' %>">
          <div class="status-indicator">
            <span class="pulse <%= pollingState.active ? 'active' : '' %>"></span>
            <span id="pollingStatusText"><%= pollingState.active ? 'Polling Active' : 'Polling Inactive' %></span>
          </div>
          <div class="status-stats">
            <div><strong>Attempts:</strong> <span id="pollAttempts"><%= pollingState.attempts %></span></div>
            <div><strong>Successes:</strong> <span id="pollSuccesses"><%= pollingState.successCount %></span></div>
            <div><strong>Last Check:</strong> <span id="pollLastCheck"><%= pollingState.lastAttempt ? new Date(pollingState.lastAttempt).toLocaleTimeString() : 'Never' %></span></div>
          </div>
        </div>
        <div class="button-group">
          <button class="btn btn-success" id="startPolling" <%= pollingState.active ? 'disabled' : '' %>>â–¶ Start Polling</button>
          <button class="btn btn-danger" id="stopPolling" <%= !pollingState.active ? 'disabled' : '' %>>â¹ Stop Polling</button>
        </div>
      </div>

      <div class="card">
        <h2>âš™ï¸ Polling Settings</h2>
        <div class="form-group">
          <label>Check Interval (seconds)</label>
          <input type="number" id="pollingInterval" value="<%= pollingSettings.intervalSeconds %>" min="1" max="300">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Start Time (NY)</label>
            <input type="time" id="pollingStartTime" step="1" value="<%= pollingSettings.startTime %>">
          </div>
          <div class="form-group">
            <label>End Time (NY)</label>
            <input type="time" id="pollingEndTime" step="1" value="<%= pollingSettings.endTime %>">
          </div>
        </div>
        <div class="form-group">
          <label>Max Attempts</label>
          <input type="number" id="pollingMaxAttempts" value="<%= pollingSettings.maxAttempts %>" min="10" max="500">
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="pollingStopOnSuccess" <%= pollingSettings.stopOnSuccess ? 'checked' : '' %>> Stop when all tasks complete</label>
        </div>
        <button class="btn btn-primary" id="savePollingSettings">Save Polling Settings</button>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content">
      <div class="card">
        <h2>ğŸ” RacquetDesk Credentials</h2>
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="rdUsername" value="<%= settings.rd_username %>">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="rdPassword" value="<%= settings.rd_password %>" placeholder="Enter password">
        </div>
        <div class="form-group">
          <label>User ID</label>
          <input type="text" id="rdUserId" value="<%= settings.rd_user_id %>" placeholder="e.g., 355252">
        </div>
        <div class="form-group">
          <label>2Captcha API Key (optional)</label>
          <input type="text" id="captchaApiKey" value="<%= settings.captcha_api_key ? 'â€¢â€¢â€¢â€¢' + settings.captcha_api_key.slice(-4) : '' %>" placeholder="For auto CAPTCHA solving">
        </div>
        <div class="form-group">
          <label>Auto Login Check Times (24h format, comma separated)</label>
          <input type="text" id="loginCheckTimes" value="<%= settings.login_check_times ? settings.login_check_times.join(', ') : '09:00, 12:00, 18:00, 21:00' %>" placeholder="e.g., 09:00, 12:00, 18:00, 21:00">
          <small style="color: #666;">System will auto-check login status at these times</small>
        </div>
        <button class="btn btn-primary" id="saveSettings">Save Settings</button>
        <div class="button-group" style="margin-top: 15px;">
          <button class="btn btn-success" id="loginRD">ğŸ”— Connect to RacquetDesk</button>
          <button class="btn btn-secondary" id="logoutRD">Disconnect</button>
        </div>
      </div>
    </div>

    <!-- Logs Tab -->
    <div id="logs-tab" class="tab-content">
      <div class="card">
        <h2>ğŸ“œ Activity Logs</h2>
        <button class="btn btn-secondary btn-small" id="clearLogs">Clear Logs</button>
        <div id="logsList" class="logs-list">
          <% logs.forEach(log => { %>
            <div class="log-item <%= log.level.toLowerCase() %>">
              <span class="log-time"><%= new Date(log.timestamp).toLocaleTimeString() %></span>
              <span class="log-level"><%= log.level %></span>
              <span class="log-message"><%= log.message %></span>
            </div>
          <% }) %>
        </div>
      </div>
    </div>

    <div id="messageArea"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/app.js"></script>
</body>
</html>
