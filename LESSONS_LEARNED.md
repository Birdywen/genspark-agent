# Lessons Learned - genspark-agent

## 2026-02-01: 变量传递功能开发

### ✅ 成功经验

1. **批量执行提升效率 5-10 倍**
2. **测试驱动开发 - 100% 通过率**
3. **增量修复 - 小步快跑**
4. **文档同步 - 代码/测试/文档一起更新**

### ⚠️ 核心教训

#### 1. 批量执行不适合写长内容 ⭐⭐⭐

**问题**: JSON 转义地狱（三层嵌套）

**教训**:
- ❌ 不要: `ΩBATCH{ write_file: "100行代码..." }`
- ✅ 应该: 单独 `write_file` 或 `run_command + heredoc`

#### 2. 深度访问条件的坑

**问题**: `apiResult.status` 条件不生效

**原因**: 过早的 `!varValue` 检查阻止了深度访问

**修复**: 移除过早检查，让深度访问优先执行

#### 3. 自动 trim 很重要

**问题**: `echo 'test'` 输出带 `\n`

**影响**: equals 匹配失败

**修复**: 保存变量时自动 trim

### 📋 最佳实践

#### 批量执行黄金法则

**✅ 适合批量**:
- 查询操作 (read_file, list_directory)
- API 调用 + 数据处理  
- 环境检查
- 简单 run_command

**❌ 不适合批量**:
- write_file 长内容 (>50行)
- edit_file 复杂修改
- 危险操作
- 巨大输出

**🔥 推荐组合**:
```
步骤1: 批量收集信息
步骤2: 单独执行关键操作  
步骤3: 批量验证结果
```

### 🎯 性能数据

- 开发时长: 3-4 小时
- 代码: 1500+ 行
- 测试通过率: 100%
- 效率提升: 3-10 倍

---

**日期**: 2026-02-01  
**版本**: v1.0.52+  
**状态**: ✅ 生产就绪

---

## 2026-02-06: System Prompt 重构 + 扫描器防打断

### ✅ 成功经验

1. **Prompt 5层分级架构** — 身份格式 → 实战指南 → 工作流程 → 环境 → Skills，优先级清晰
2. **去重效果显著** — 消除4处重复（本地环境/TODO/代码修改/工具调用偏好），token减少约40%
3. **实战经验融入Prompt** — 把 LESSONS_LEARNED 中的批量执行黄金法则直接写入系统提示词
4. **扫描器三重防护有效** — 连续确认+稳定窗口+快照对比，解决了AI输出被打断的问题

### ⚠️ 核心教训

#### 1. 时间阈值需要平衡 ⭐⭐⭐

**问题**: 初版防打断参数太保守（1500ms + 5次确认），用户反馈过慢

**最终参数**: 1000ms稳定窗口 + 3次连续确认（约600ms）

**教训**: 安全性和响应速度需要平衡，先保守再根据反馈调优

#### 2. write_file 写长内容在某些环境下会静默失败 ⭐⭐

**问题**: write_file 写入长markdown文档（>100行）时文件未创建，无错误提示

**解决**: 用 run_command + stdin (bash heredoc) 方式写入

#### 3. DOM信号不可全信 ⭐⭐

**问题**: isAIGenerating() 依赖停止按钮和CSS类名，在token间隙会瞬间返回false

**解决**: 不依赖单次检测，要求连续多次确认才算真正停止

### 📋 最佳实践

#### Prompt设计原则

- 每条信息只出现一次，杜绝重复
- 最重要的信息放最前面
- 融入实战经验而非纯理论
- 信息密度要高，删除正确的废话

#### 扫描器参数调优

- 先用保守参数上线，确保不打断
- 根据用户反馈逐步降低延迟
- 慢一点也有好处：降低被网站限制的风险

### 🎯 改动范围

- Prompt: content.js generateSystemPrompt() 重写
- 扫描器: scanForToolCalls() 增加三重防护
- 配置: toolCount 默认值 67→131
- 精简: .ai-env.md 从~60行到11行
- 文档: PROMPT_REDESIGN.md, PROMPT_V2_TEMPLATE.md
- 同步: 5个extension全部更新

---

**日期**: 2026-02-06  
**版本**: v1.0.53  
**状态**: ✅ 生产就绪
