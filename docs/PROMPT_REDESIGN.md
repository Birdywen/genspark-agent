# System Prompt 重新设计方案

## 设计原则

1. **分层架构** — 最重要的信息放最前面，AI 最先读到
2. **去重** — 每条信息只出现一次
3. **实战驱动** — 融入 LESSONS_LEARNED 中的真实经验
4. **信息密度** — 每一句话都要有信息量
5. **动态适配** — 工具数量、版本号从运行时获取

---

## 当前问题清单

| # | 问题 | 严重度 |
|---|------|--------|
| 1 | 本地环境 重复2次 (主prompt + .ai-env.md) | 高 |
| 2 | TODO机制 重复2次 | 高 |
| 3 | 代码修改偏好 重复2次 | 高 |
| 4 | 工具调用偏好 重复2次 | 高 |
| 5 | PLAN/FLOW/RESUME 说明空洞 | 中 |
| 6 | toolCount 默认值67过时(实际131+) | 中 |
| 7 | 批量执行长内容陷阱未警告 | 中 |
| 8 | Skills prompt 拼接粗糙 | 低 |

---

## 新 Prompt 5层结构

```
第1层: 身份+格式 (~400 tokens) — 必读
  |- 身份声明
  |- 工具调用格式 (单个 / 批量)
  |- 核心规则 (5条精简)

第2层: 实战指南 (~500 tokens) — 高频使用
  |- 命令转义 (stdin规则)
  |- 代码修改选择 (edit_file vs write_file)
  |- 批量执行黄金法则 (来自LESSONS_LEARNED)
  |- 语法验证规则

第3层: 工作流程 (~300 tokens) — 按需参考
  |- 新对话上下文恢复
  |- TODO机制
  |- 错误处理

第4层: 环境信息 (~200 tokens) — 参考
  |- 系统 + 可用工具概览
  |- SSH远程
  |- 服务器重启

第5层: Skills (动态附加)
```

---

## Token 估算

| 部分 | 旧 | 新 |
|------|----|----|
| 主 prompt | ~2000 | ~1200 |
| .ai-env.md | ~400 | ~100 |
| Skills | ~300 | ~300 |
| **合计** | **~2700** | **~1600** |
| **节省** | — | **~40%** |

---

## 改动总结

### 删除
- 主prompt中的 "本地环境" 段 (与 .ai-env.md 重复)
- .ai-env.md 中的 TODO/代码修改/工具调用偏好 (与主 prompt 重复)
- PLAN/FLOW/RESUME 独立段落 (合并为一行速查)
- "里程碑记录" 规则 (几乎不触发)
- "输出格式规范" 独立段 (合并到格式说明首句)

### 新增 (来自 LESSONS_LEARNED)
- 批量执行黄金法则
- 推荐模式: 收集 -> 执行 -> 验证
- 长内容不适合批量警告

### 合并
- 本地环境: 2处 -> 1处
- TODO: 2处 -> 1处
- 代码修改: 2处 -> 1处
- SSH/重启/工具列表: 3个独立段 -> 1个子段

---

## 实施步骤

1. 更新 .ai-env.md — 删除重复内容，只保留补充信息
2. 更新 content.js generateSystemPrompt() — 替换为新 prompt
3. 修复 toolCount 默认值 — 67 -> 131 或动态获取
4. 验证语法 — node -c content.js
5. 同步到其他 extension (galaxy, hixx, kimi, vear)
6. 测试 — 复制 prompt 检查完整性

---

## 新版 Prompt 全文 (用于替换 generateSystemPrompt)

见 PROMPT_V2_TEMPLATE.md
