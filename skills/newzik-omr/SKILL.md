# Newzik OMR MusicXML Correction Skill

## Overview
This skill guides AI agents in detecting and correcting errors in MusicXML files
generated by the Newzik/Maestria OMR (Optical Music Recognition) engine v2.7.2.

Based on analysis of 6 pieces across Baroque, Classical, and Romantic periods:
- 01-Rondo in D minor (Purcell)
- 05-Air on the G String (Bach)
- 08-Ode to Joy (Beethoven)
- 11-Für Elise (Beethoven)
- 12-Ave Maria (Schubert)
- 15-Prelude Op.28 No.7 (Chopin)

## Known Systematic Error Patterns

### 1. CHORD SYMBOLS AS DIRECTIONS (Critical, ~80% of pieces)
**Pattern:** Chord symbol text (Am, E7, D, Gm, etc.) placed in `<direction><words>`
instead of `<harmony>` elements.

**Detection:**
```python
for d in measure.findall("direction"):
    w = d.findtext(".//words", "").strip()
    # If text matches chord pattern, it belongs in <harmony>
    if re.match(r"^[A-G][b#]?(m|dim|aug|maj|min|7|9|sus|add|6)?[0-9]?$", w):
        # This is a chord symbol, not a direction
```

**Common misreads:**
- "Am®" -> "Am" (A minor) — garbled characters appended
- "D?" -> "D" (D major) — question mark artifact  
- "E!" -> "E" (E major) — exclamation artifact
- "td" -> junk fragment, delete
- "Prelude" -> title text leaked into directions, delete
- "St" -> "Stately" — tempo text truncated
- "N.C." -> keep as direction (No Chord is valid)

**Fix:** Remove direction, create `<harmony>` with proper `<root>` and `<kind>`.

**Chord text to harmony mapping:**
```python
chord_map = {
    "Am": ("A", "minor"), "A": ("A", "major"),
    "Bb": ("B", "major", "-1"), "Bm": ("B", "minor"),
    "C": ("C", "major"), "Cm": ("C", "minor"),
    "D": ("D", "major"), "Dm": ("D", "minor"), "D7": ("D", "dominant"),
    "E": ("E", "major"), "Em": ("E", "minor"), "E7": ("E", "dominant"),
    "F": ("F", "major"), "Fm": ("F", "minor"),
    "G": ("G", "major"), "Gm": ("G", "minor"), "G7": ("G", "dominant"),
    # Clean garbled suffixes first: strip ®©?! etc.
}
```

### 2. HARMONY KIND MISIDENTIFICATION (Common)
**Pattern:** OMR confuses chord qualities, especially:
- "augmented" when it should be "major" (seen in A chords, Purcell)
- "diminished" when it should be "major" (seen in C chord, Beethoven)
- "minor" when it should be "major" (seen in A chord, repeat sections)

**Detection:** Cross-reference with:
1. The same passage in a repeated section (A section = A\' section)
2. Bass notes and key context
3. Accidentals in the melody (C# implies major, not minor)

**Rule of thumb:** If a harmony label seems unusual for the style period:
- Baroque: augmented chords are extremely rare
- Classical: diminished chords on non-leading-tone roots are suspicious
- Check if the root note + kind actually match the sounding pitches

### 3. MISSING REPEAT BARLINES (Common)
**Pattern:** One half of a repeat pair is present, the other is missing.

**Detection:**
```python
repeats = []
for m in measures:
    for bl in m.findall("barline"):
        rep = bl.find("repeat")
        if rep is not None:
            repeats.append((m.get("number"), rep.get("direction")))
# Check: every "backward" should have a matching "forward" (or piece start)
# Check: sections that repeat in the score have both forward+backward
```

**Common cases:**
- Forward repeat at piece start missing (implied but not encoded)
- B section repeat: backward present, forward missing (or vice versa)

### 4. VOICE/STAFF ASSIGNMENT ERRORS (Occasional, Severe)
**Pattern:** Notes assigned to wrong voice/staff combination. Treble notes
in voice 2 / staff 2, bass notes in voice 1 / staff 1.

**Detection:**
```python
for note in measure.findall("note"):
    octave = int(note.findtext("pitch/octave", "4"))
    staff = note.findtext("staff", "")
    if octave >= 4 and staff == "2":  # Treble note on bass staff
        flag_error()
    if octave <= 3 and staff == "1":  # Bass note on treble staff
        flag_error()
```

**Also check:** Duration totals per voice don\'t match expected measure length.
This is often the symptom that reveals the voice assignment is garbled.

**Fix approach:** Reassign by octave (>= 4 -> v1/s1, <= 3 -> v2/s2),
or clone from a structurally identical measure elsewhere in the piece.

### 5. MISSING STAFF ELEMENTS (Occasional)
**Pattern:** `<staff>` element missing or empty on notes, especially rests
in voice 3+ or inner voices.

**Detection:**
```python
for note in measure.findall("note"):
    staff_el = note.find("staff")
    if staff_el is None or not staff_el.text:
        flag_error()
```

**Fix:** Assign based on voice number (voice 1 -> staff 1, voice 2+ -> staff 2)
or based on pitch range.

### 6. INCOMPLETE MEASURES / MISSING NOTES (Occasional)
**Pattern:** A voice\'s duration sum doesn\'t equal the expected measure length.
Notes may be missing (OMR failed to detect them).

**Detection:**
```python
cur_div = 1
for measure in measures:
    # Track division changes
    div = measure.findtext(".//attributes/divisions")
    if div: cur_div = int(div)
    expected = cur_div * beats_per_measure
    # Sum durations per voice (excluding chord notes)
    for voice_id, total_dur in voice_durations.items():
        if total_dur != expected:
            flag_error(measure, voice_id, total_dur, expected)
```

**Fix approaches (in order of preference):**
1. Find a structurally identical measure and clone its content
2. Add `<forward>` elements to pad the missing duration
3. Add rests to fill the gap

### 7. TITLE/TEXT OCR ERRORS (Common, Low severity)
**Pattern:** Special characters misread:
- "ü" -> "ii" (Für -> Fiir)
- Accented chars mangled (Frédéric OK in some cases)
- Text truncated ("Stately" -> "St")
- Garbage characters appended ("®", "©", "?", "!")

**Fix:** Manual correction based on known piece names.

### 8. PIECE TRUNCATION (Occasional, Severe)
**Pattern:** MusicXML contains fewer measures than the source PDF.
The OMR only captured part of the piece.

**Observed in:** Für Elise (14 of ~30+ measures), Ave Maria (12 of ~20+ measures)

**Detection:** Compare measure count with known piece length, or count
measures visible in the PDF pages.

**Fix:** Cannot be auto-fixed. Requires re-running OMR or manual entry.

### 9. PICKUP MEASURE DURATION (Not an error)
**Pattern:** First measure has shorter duration than expected.
This is correct for pieces with anacrusis/pickup beats.

**Known pieces with pickup:** Für Elise (1 beat), Chopin Prelude (1 beat)

**Rule:** If m1 duration < expected AND it\'s a known pickup piece, ignore.
Also check if the last measure is correspondingly shortened.

### 10. DIVISIONS CHANGES (Not an error, but important)
**Pattern:** `<divisions>` value changes frequently between measures.
This is valid MusicXML but makes duration calculations complex.

**Rule:** Always track current divisions when computing expected durations.
Don\'t assume divisions is constant throughout the piece.

## Correction Workflow

### Phase 1: Automated Checks
```
1. Parse MusicXML, extract all measures
2. Track divisions changes
3. Check duration totals per voice per measure
4. Flag measures where any voice total != expected
5. Scan for chord-text in directions
6. Check repeat barline pairing
7. Check staff element presence on all notes
8. Compare measure count with PDF page count estimate
```

### Phase 2: Visual Comparison
```
1. Convert PDF to PNG (magick -density 200 input.pdf output-page%d.png)
2. Read each page with read_media_file
3. Compare key signature, time signature, tempo marking
4. Spot-check first measure, repeat boundaries, and final measure
5. Focus on flagged measures from Phase 1
```

### Phase 3: Structural Cross-Reference
```
1. Identify repeated sections (A-B-A, verse-chorus, etc.)
2. Compare corresponding measures (m1 vs m17, m7 vs m34, etc.)
3. Harmonies in repeated sections should match
4. Notes in repeated sections should match (or be intentional variations)
```

### Phase 4: Apply Fixes
```
1. Convert chord directions to harmony elements
2. Fix harmony kinds (augmented->major, etc.)
3. Add missing repeat barlines
4. Fix voice/staff assignments
5. Add missing staff elements
6. Pad incomplete measures with forward/rest
7. Fix title text
8. Save and verify all duration totals
```

## Statistics from Analysis

| Piece | Measures | Errors Found | Error Types |
|-------|----------|-------------|-------------|
| Purcell Rondo | 35 | 8 | Harmony kind (5), repeat barline (2), voice/staff garble (1) |
| Bach Air | 36 | 3 | Chord-as-direction (2), missing repeat-forward (1) |
| Beethoven Ode | 16 | 4 | Missing staff (2), tempo truncated (1), harmony kind (1) |
| Beethoven Fur Elise | 14 | 7+note | Title OCR (1), chord-as-direction (4), missing v2 rest (1), truncation |
| Schubert Ave Maria | 12 | 3+note | Incomplete measure (1), title (1), truncation |
| Chopin Prelude | 17 | 14 | Chord-as-direction (6), junk directions (8), empty dirs cleanup |

**Most common error types (ranked):**
1. Chord symbols placed in direction instead of harmony (~40% of all errors)
2. Harmony kind misidentification (~20%)
3. Junk/garbled direction text (~15%)
4. Missing repeat barlines (~10%)
5. Voice/staff assignment errors (~5%)
6. Missing notes/incomplete measures (~5%)
7. Title/text OCR errors (~5%)

## File Locations
- Source PDFs: `/Users/yay/workspace/popular-classics-split/songs/`
- MusicXML files: `/Users/yay/workspace/genspark-agent/skills/newzik-omr/converted/`
- This skill: `/Users/yay/workspace/genspark-agent/skills/newzik-omr/SKILL.md`
